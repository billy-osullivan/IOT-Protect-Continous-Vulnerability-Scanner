# Author:   		William O Sullivan
# Purpose:  		This script controlls the LCD and the Apache service

from time import sleep, strftime
from datetime import datetime
from Adafruit_CharLCD import Adafruit_CharLCD
import socket
import RPi.GPIO as GPIO
import os

def indexip():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.connect(("8.8.8.8",80))
    return s.getsockname()[0]

sleep(80) # allow time for everything else to boot

lcd = Adafruit_CharLCD(rs=26,en=19,d4=13,d5=6,d6=11,d7=9,cols=16,lines=2)
lcd.clear()

GPIO.setmode(GPIO.BCM)
GPIO.setup(17, GPIO.IN, pull_up_down=GPIO.PUD_UP)

os.system("sudo /home/pi/apachestop.sh")
while True:
	try:
		button = GPIO.input(17)
		lcd.clear()
		ip = indexip()
		lcd.message(datetime.now().strftime('%b %d %H:%M:%S\n'))
		lcd.message('IP {}'.format(ip))   
		if button == False:
			sleep(0.2) #debounce for switch
			os.system("sudo /home/pi/apachestart.sh")
			timer = 300
			while timer>0:
				lcd.clear()
				lcd.message("Webservice ON\nFor: "+ str(timer) + " seconds")
				timer = timer - 1
				sleep(1)
			os.system("sudo /home/pi/apachestop.sh")
		sleep(0.2)
	except:
		lcd.clear()
		lcd.message('network\nconnection error')
		sleep(4)
		lcd.clear()
		lcd.message('Retrying...')	
		sleep(4)
		lcd.clear()    

